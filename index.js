var child_process = require("child_process");
var http = require("http");
var Promise = require("bluebird");
var async = require("async");
module.exports = function (obj) {
    var response = {};
    var tests = [];
    var kernelserverFn = function (callback) {
        console.log("server");
        var callbacked = false;
        http.get("http://ingecotech.com:9090/ip", function (res) {
            res.setEncoding('utf8');
            res.on("data", function (body) {
                if (body && JSON.parse(body) && JSON.parse(body).ip) {
                    response.server = true;
                    response.ip = JSON.parse(body).ip;
                }
                else {
                    response.server = false;
                    response.ip = "none";
                }
            });
            res.on('end', function () {
                callback();
                callbacked = true;
            });
        }).on('error', function (e) {
            response.server = false;
            callbacked = true;
            response.ip = "none";
            callback(new Error(e));
        });
        setTimeout(function () {
            if (!callbacked) {
                response.ip = "none";
                response.server = false;
                callback(new Error("no response from server"));
            }
        }, 10000);
    };
    var googleFn = function (callback) {
        console.log("get");
        var callbacked = false;
        http.get("http://www.google.com/index.html", function () {
            response.get = true;
            callbacked = true;
            callback();
        }).on('error', function (e) {
            response.get = false;
            callbacked = true;
            callback(new Error(e));
        });
        setTimeout(function () {
            if (!callbacked) {
                response.get = false;
                callback(new Error("no response from google"));
            }
        }, 10000);
    };
    var pingFn = function (callback) {
        var callbacked = false;
        console.log("ping");
        child_process.exec(__dirname + "/ping.sh", { timeout: 10000 }, function (error, stdout, stderr) {
            if (error != null) {
                response.ping = false;
                callbacked = true;
                callback(new Error(error + ""));
            }
            else if (stderr && stderr != null) {
                response.ping = false;
                callbacked = true;
                callback(new Error(stderr + ""));
            }
            else {
                callbacked = true;
                response.ping = true;
                callback();
            }
        });
        setTimeout(function () {
            if (!callbacked) {
                response.ping = false;
                callback(new Error("no ping"));
            }
        }, 10000);
    };
    if (!obj) {
        tests.push(pingFn, googleFn, kernelserverFn);
    }
    else {
        if (obj.ping) {
            tests.push(pingFn);
        }
        if (obj.get) {
            tests.push(googleFn);
        }
        if (obj.server) {
            if (obj.server == true) {
                tests.push(kernelserverFn);
            }
            else {
                var serverFn = function (callback) {
                    var callbacked = false;
                    setTimeout(function () {
                        if (!callbacked) {
                            response.ip = "none";
                            response.server = false;
                            callback(new Error("no response"));
                        }
                    }, 10000);
                    http.get(obj.server, function (res) {
                        response.server = true;
                        callbacked = true;
                        callback();
                    }).on('error', function (e) {
                        response.server = false;
                        callbacked = true;
                        callback(new Error(e));
                    });
                };
                tests.push(serverFn);
            }
        }
        ;
    }
    return new Promise(function (resolve, reject) {
        async.series(tests, function (err, results) {
            if (err) {
                reject(response);
            }
            else {
                resolve(response);
            }
        });
    });
};

//# sourceMappingURL=data:application/json;base64,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QUNyQixDQUFDO1FBR0wsQ0FBQyxDQUFDLENBQUM7SUFFWCxDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUMsQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNoaWxkX3Byb2Nlc3MgZnJvbSBcImNoaWxkX3Byb2Nlc3NcIjtcbmltcG9ydCAqIGFzIGh0dHAgZnJvbSBcImh0dHBcIjtcbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSBcImJsdWViaXJkXCI7XG5pbXBvcnQgKiBhcyBhc3luYyBmcm9tIFwiYXN5bmNcIjtcblxuXG5leHBvcnQgPWZ1bmN0aW9uKG9iajogeyBzZXJ2ZXI6IGFueSwgcGluZzogYm9vbGVhbiwgZ2V0OiBib29sZWFuIH0pIHtcblxuXG4gICAgbGV0IHJlc3BvbnNlOiB7IHBpbmc/OiBib29sZWFuLCBnZXQ/OiBib29sZWFuLCBzZXJ2ZXI/OiBib29sZWFuLCBpcD86IHN0cmluZyB9ID0ge307XG5cblxuICAgIGxldCB0ZXN0cyA9IFtdO1xuXG5cblxuICAgIGxldCBrZXJuZWxzZXJ2ZXJGbiA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwic2VydmVyXCIpXG5cbiAgICAgICAgbGV0IGNhbGxiYWNrZWQgPSBmYWxzZTtcbiAgICAgICAgaHR0cC5nZXQoXCJodHRwOi8vaW5nZWNvdGVjaC5jb206OTA5MC9pcFwiLCBmdW5jdGlvbihyZXMpIHtcblxuICAgICAgICAgICAgcmVzLnNldEVuY29kaW5nKCd1dGY4Jyk7XG5cbiAgICAgICAgICAgIHJlcy5vbihcImRhdGFcIiwgZnVuY3Rpb24oYm9keSkge1xuICAgICAgICAgICAgICAgIGlmIChib2R5ICYmIEpTT04ucGFyc2UoYm9keSkgJiYgSlNPTi5wYXJzZShib2R5KS5pcCkge1xuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5zZXJ2ZXIgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5pcCA9IEpTT04ucGFyc2UoYm9keSkuaXA7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2Uuc2VydmVyID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmlwID0gXCJub25lXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXMub24oJ2VuZCcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKClcbiAgICAgICAgICAgICAgICBjYWxsYmFja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHJlc3BvbnNlLnNlcnZlciA9IGZhbHNlO1xuICAgICAgICAgICAgY2FsbGJhY2tlZCA9IHRydWU7XG4gICAgICAgICAgICByZXNwb25zZS5pcCA9IFwibm9uZVwiO1xuICAgICAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKGUpKVxuICAgICAgICB9KTtcblxuXG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBpZiAoIWNhbGxiYWNrZWQpIHtcbiAgICAgICAgICAgICAgICByZXNwb25zZS5pcCA9IFwibm9uZVwiO1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlLnNlcnZlciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihcIm5vIHJlc3BvbnNlIGZyb20gc2VydmVyXCIpKVxuICAgICAgICAgICAgfVxuICAgICAgICB9LCAxMDAwMClcblxuICAgIH07XG5cblxuXG5cbiAgICBsZXQgZ29vZ2xlRm4gPSBmdW5jdGlvbihjYWxsYmFjaykge1xuICAgICAgICBjb25zb2xlLmxvZyhcImdldFwiKVxuICAgICAgICBsZXQgY2FsbGJhY2tlZCA9IGZhbHNlO1xuICAgICAgICBodHRwLmdldChcImh0dHA6Ly93d3cuZ29vZ2xlLmNvbS9pbmRleC5odG1sXCIsIGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIGNvbnN1bWUgcmVzcG9uc2UgYm9keVxuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXNwb25zZS5nZXQgPSB0cnVlO1xuICAgICAgICAgICAgY2FsbGJhY2tlZCA9IHRydWU7XG4gICAgICAgICAgICBjYWxsYmFjaygpXG4gICAgICAgIH0pLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHJlc3BvbnNlLmdldCA9IGZhbHNlO1xuICAgICAgICAgICAgY2FsbGJhY2tlZCA9IHRydWU7XG4gICAgICAgICAgICBjYWxsYmFjayhuZXcgRXJyb3IoZSkpXG4gICAgICAgIH0pO1xuICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgaWYgKCFjYWxsYmFja2VkKSB7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2UuZ2V0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKFwibm8gcmVzcG9uc2UgZnJvbSBnb29nbGVcIikpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIDEwMDAwKVxuXG4gICAgfTtcblxuICAgIGxldCBwaW5nRm4gPSBmdW5jdGlvbihjYWxsYmFjaykge1xuICAgICAgICBsZXQgY2FsbGJhY2tlZCA9IGZhbHNlO1xuICAgICAgICBjb25zb2xlLmxvZyhcInBpbmdcIilcbiAgICAgICAgY2hpbGRfcHJvY2Vzcy5leGVjKF9fZGlybmFtZSArIFwiL3Bpbmcuc2hcIiwgeyB0aW1lb3V0OiAxMDAwMCB9LCBmdW5jdGlvbihlcnJvciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnJvciAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgcmVzcG9uc2UucGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG5ldyBFcnJvcihlcnJvciArIFwiXCIpKVxuICAgICAgICAgICAgfSBlbHNlIGlmIChzdGRlcnIgJiYgc3RkZXJyICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXNwb25zZS5waW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKHN0ZGVyciArIFwiXCIpKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICByZXNwb25zZS5waW5nID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjaygpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBpZiAoIWNhbGxiYWNrZWQpIHtcbiAgICAgICAgICAgICAgICByZXNwb25zZS5waW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sobmV3IEVycm9yKFwibm8gcGluZ1wiKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgMTAwMDApXG4gICAgfVxuXG5cbiAgICBpZiAoIW9iaikge1xuXG5cblxuICAgICAgICB0ZXN0cy5wdXNoKHBpbmdGbiwgZ29vZ2xlRm4sIGtlcm5lbHNlcnZlckZuKVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChvYmoucGluZykge1xuICAgICAgICAgICAgdGVzdHMucHVzaChwaW5nRm4pXG4gICAgICAgIH1cblxuICAgICAgICBpZiAob2JqLmdldCkge1xuICAgICAgICAgICAgdGVzdHMucHVzaChnb29nbGVGbilcbiAgICAgICAgfVxuXG5cbiAgICAgICAgaWYgKG9iai5zZXJ2ZXIpIHtcblxuXG4gICAgICAgICAgICBpZiAob2JqLnNlcnZlciA9PSB0cnVlKSB7XG5cblxuICAgICAgICAgICAgICAgIHRlc3RzLnB1c2goa2VybmVsc2VydmVyRm4pXG4gICAgICAgICAgICB9IGVsc2Uge1xuXG5cbiAgICAgICAgICAgICAgICBsZXQgc2VydmVyRm4gPSBmdW5jdGlvbihjYWxsYmFjaykge1xuXG4gICAgICAgICAgICAgICAgICAgIGxldCBjYWxsYmFja2VkID0gZmFsc2U7XG5cblxuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjYWxsYmFja2VkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UuaXAgPSBcIm5vbmVcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5zZXJ2ZXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhuZXcgRXJyb3IoXCJubyByZXNwb25zZVwiKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSwgMTAwMDApXG5cbiAgICAgICAgICAgICAgICAgICAgaHR0cC5nZXQob2JqLnNlcnZlciwgZnVuY3Rpb24ocmVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZS5zZXJ2ZXIgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjaygpXG4gICAgICAgICAgICAgICAgICAgIH0pLm9uKCdlcnJvcicsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLnNlcnZlciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhuZXcgRXJyb3IoZSkpXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgdGVzdHMucHVzaChzZXJ2ZXJGbilcbiAgICAgICAgICAgIH1cblxuXG5cblxuICAgICAgICB9O1xuXG5cblxuICAgIH1cblxuXG5cblxuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcblxuXG4gICAgICAgIGFzeW5jLnNlcmllcyh0ZXN0cyxcbiAgICAgICAgICAgIC8vIG9wdGlvbmFsIGNhbGxiYWNrXG4gICAgICAgICAgICBmdW5jdGlvbihlcnIsIHJlc3VsdHMpIHtcblxuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHJlc3BvbnNlKVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIHRoZSByZXN1bHRzIGFycmF5IHdpbGwgZXF1YWwgWydvbmUnLCd0d28nXSBldmVuIHRob3VnaFxuICAgICAgICAgICAgICAgIC8vIHRoZSBzZWNvbmQgZnVuY3Rpb24gaGFkIGEgc2hvcnRlciB0aW1lb3V0LlxuICAgICAgICAgICAgfSk7XG5cbiAgICB9KVxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
